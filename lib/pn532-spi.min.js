"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,_){if(!(e instanceof _))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,_){for(var t=0;t<_.length;t++){var N=_[t];N.enumerable=N.enumerable||!1,N.configurable=!0,"value"in N&&(N.writable=!0),Object.defineProperty(e,N.key,N)}}return function(_,t,N){return t&&e(_.prototype,t),N&&e(_,N),_}}(),_sleep=require("sleep"),_sleep2=_interopRequireDefault(_sleep),_rpiSoftspi=require("rpi-softspi"),_rpiSoftspi2=_interopRequireDefault(_rpiSoftspi),PN532_FRAME_LENGTH=8,PN532_PREAMBLE=0,PN532_STARTCODE1=0,PN532_STARTCODE2=255,PN532_POSTAMBLE=0,PN532_HOSTTOPN532=212,PN532_PN532TOHOST=213,PN532_COMMAND_DIAGNOSE=0,PN532_COMMAND_GETFIRMWAREVERSION=2,PN532_COMMAND_GETGENERALSTATUS=4,PN532_COMMAND_READREGISTER=6,PN532_COMMAND_WRITEREGISTER=8,PN532_COMMAND_READGPIO=12,PN532_COMMAND_WRITEGPIO=14,PN532_COMMAND_SETSERIALBAUDRATE=16,PN532_COMMAND_SETPARAMETERS=18,PN532_COMMAND_samCONFIGURATION=20,PN532_COMMAND_POWERDOWN=22,PN532_COMMAND_RFCONFIGURATION=50,PN532_COMMAND_RFREGULATIONTEST=88,PN532_COMMAND_INJUMPFORDEP=86,PN532_COMMAND_INJUMPFORPSL=70,PN532_COMMAND_INLISTPASSIVETARGET=74,PN532_COMMAND_INATR=80,PN532_COMMAND_INPSL=78,PN532_COMMAND_INDATAEXCHANGE=64,PN532_COMMAND_INCOMMUNICATETHRU=66,PN532_COMMAND_INDESELECT=68,PN532_COMMAND_INRELEASE=82,PN532_COMMAND_INSELECT=84,PN532_COMMAND_INAUTOPOLL=96,PN532_COMMAND_TGINITASTARGET=140,PN532_COMMAND_TGSETGENERALBYTES=146,PN532_COMMAND_TGGETDATA=134,PN532_COMMAND_TGSETDATA=142,PN532_COMMAND_TGSETMETADATA=148,PN532_COMMAND_TGGETINITIATORCOMMAND=136,PN532_COMMAND_TGRESPONSETOINITIATOR=144,PN532_COMMAND_TGGETTARGETSTATUS=138,PN532_RESPONSE_INDATAEXCHANGE=65,PN532_RESPONSE_INLISTPASSIVETARGET=75,PN532_WAKEUP=85,PN532_SPI_STATREAD=2,PN532_SPI_DATAWRITE=1,PN532_SPI_DATAREAD=3,PN532_SPI_READY=1,PN532_MIFARE_ISO14443A=0,MIFARE_CMD_AUTH_A=96,MIFARE_CMD_AUTH_B=97,MIFARE_CMD_READ=48,MIFARE_CMD_WRITE=160,MIFARE_CMD_TRANSFER=176,MIFARE_CMD_DECREMENT=192,MIFARE_CMD_INCREMENT=193,MIFARE_CMD_STORE=194,MIFARE_ULTRALIGHT_CMD_WRITE=162,NDEF_URIPREFIX_NONE=0,NDEF_URIPREFIX_HTTP_WWWDOT=1,NDEF_URIPREFIX_HTTPS_WWWDOT=2,NDEF_URIPREFIX_HTTP=3,NDEF_URIPREFIX_HTTPS=4,NDEF_URIPREFIX_TEL=5,NDEF_URIPREFIX_MAILTO=6,NDEF_URIPREFIX_FTP_ANONAT=7,NDEF_URIPREFIX_FTP_FTPDOT=8,NDEF_URIPREFIX_FTPS=9,NDEF_URIPREFIX_SFTP=10,NDEF_URIPREFIX_SMB=11,NDEF_URIPREFIX_NFS=12,NDEF_URIPREFIX_FTP=13,NDEF_URIPREFIX_DAV=14,NDEF_URIPREFIX_NEWS=15,NDEF_URIPREFIX_TELNET=16,NDEF_URIPREFIX_IMAP=17,NDEF_URIPREFIX_RTSP=18,NDEF_URIPREFIX_URN=19,NDEF_URIPREFIX_POP=20,NDEF_URIPREFIX_SIP=21,NDEF_URIPREFIX_SIPS=22,NDEF_URIPREFIX_TFTP=23,NDEF_URIPREFIX_BTSPP=24,NDEF_URIPREFIX_BTL2CAP=25,NDEF_URIPREFIX_BTGOEP=26,NDEF_URIPREFIX_TCPOBEX=27,NDEF_URIPREFIX_IRDAOBEX=28,NDEF_URIPREFIX_FILE=29,NDEF_URIPREFIX_URN_EPC_ID=30,NDEF_URIPREFIX_URN_EPC_TAG=31,NDEF_URIPREFIX_URN_EPC_PAT=32,NDEF_URIPREFIX_URN_EPC_RAW=33,NDEF_URIPREFIX_URN_EPC=34,NDEF_URIPREFIX_URN_NFC=35,PN532_GPIO_VALIDATIONBIT=128,PN532_GPIO_P30=0,PN532_GPIO_P31=1,PN532_GPIO_P32=2,PN532_GPIO_P33=3,PN532_GPIO_P34=4,PN532_GPIO_P35=5,PN532_ACK=Uint8Array.from([1,0,0,255,0,255,0]),PN532_FRAME_START=Uint8Array.from([1,0,0,255]),PN532=function(){function e(_){_classCallCheck(this,e),this.client=_.client,this.clock=_.clock,this.mosi=_.mosi,this.miso=_.miso,this.debug=_.debug||!1,this.clockMode=0,this.bitOrder=_rpiSoftspi2.default.LSB,this.spi=new _rpiSoftspi2.default({clock:this.clock,mosi:this.mosi,miso:this.miso,client:this.client,bitOrder:this.bitOrder})}return _createClass(e,[{key:"_spiOpen",value:function(){this.spi.open(),_sleep2.default.msleep(2)}},{key:"_spiClose",value:function(){this.spi.close()}},{key:"_uint8Add",value:function(e,_){return(255&e)+(255&_)&255}},{key:"_writeFrame",value:function(e){var _=e.length;if(!(0<e.length<255))throw"Data must be array of 1 to 255 bytes";var t=[PN532_SPI_DATAWRITE,PN532_PREAMBLE,PN532_STARTCODE1,PN532_STARTCODE2,255&_,this._uint8Add(~_,1)].concat(e),N=e.reduce(this._uint8Add,255);t.push(255&~N),t.push(PN532_POSTAMBLE),this.debug&&console.log("Writing frame: ",t),this._spiOpen(),this.spi.write(t),this._spiClose()}},{key:"_readData",value:function(e){var _=new Uint8Array(e);_[0]=PN532_SPI_DATAREAD,this._spiOpen();var t=this.spi.transfer(_);return this._spiClose(),t}},{key:"_readFrame",value:function(e){var _=this._readData(e+PN532_FRAME_LENGTH);if(this.debug&&console.log("Read frame: ",_),1!=_[0])throw"Response frame does not start with 0x01!";for(var t=1;0==_[t];)if((t+=1)>=_.length)throw"Response frame preamble does not contain 0x00FF!";if(255!=_[t])throw"Response frame preamble does not contain 0x00FF!";if((t+=1)>=_.length)throw"Response contains no data!";var N=_[t];if(N+_[t+1]&!0)throw"Response length checksum did not match length!";var i=_.slice(t+2,t+2+N+1);if(0!=i.reduce(this._uint8Add,0))throw"Response checksum did not match expected value!";return i.slice(0,i.length-1)}},{key:"_waitReady",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,_=new Date;this._spiOpen();var t=this.spi.transfer([PN532_SPI_STATREAD,0]);for(this._spiClose();t[1]!=PN532_SPI_READY;){if(new Date-_>=1e3*e)return!1;_sleep2.default.msleep(10),this._spiOpen(),t=this.spi.transfer([PN532_SPI_STATREAD,0]),this._spiClose()}return!0}},{key:"callFunction",value:function(e){var _=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],N=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=[PN532_HOSTTOPN532,255&e].concat(t);if(this._writeFrame(i),!this._waitReady(N))return null;var E=this._readData(PN532_ACK.length);if(E.toString()!=PN532_ACK.toString())throw"Did not receive expected ACK from PN532!";if(!this._waitReady(N))return null;if((E=this._readFrame(_+2))[0]!=PN532_PN532TOHOST||E[1]!=e+1)throw"Received unexpected command response!";return E.slice(2,E.length)}},{key:"begin",value:function(){this._spiOpen(),_sleep2.default.sleep(1),this.getFirmwareVersion(),this._spiClose()}},{key:"getFirmwareVersion",value:function(){var e=this.callFunction(PN532_COMMAND_GETFIRMWAREVERSION,4);if(null==e)throw"Failed to detect the PN532!  Make sure there is sufficient power (use a 1 amp or greater power supply), the PN532 is wired correctly to the device, and the solder joints on the PN532 headers are solidly connected.";return[e[0],e[1],e[2],e[3]]}},{key:"samConfiguration",value:function(){this.callFunction(PN532_COMMAND_samCONFIGURATION,0,[1,20,1])}},{key:"readPassiveTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:PN532_MIFARE_ISO14443A,_=(arguments.length>1&&void 0!==arguments[1]&&arguments[1],this.callFunction(PN532_COMMAND_INLISTPASSIVETARGET,17,[1,e]));if(null==_)return null;if(1!=_[0])throw"More than one card detected!";if(_[5]>7)throw"Found card with unexpectedly long UID!";return _.slice(6,6+_[5])}},{key:"mifareClassicAuthenticateBlock",value:function(e,_,t,N){e.length,N.length;var i=[1,255&t,255&_].concat(N).concat(e);return 0==this.callFunction(PN532_COMMAND_INDATAEXCHANGE,1,i)[0]}},{key:"mifareClassicReadBlock",value:function(e){var _=this.callFunction(PN532_COMMAND_INDATAEXCHANGE,17,[1,MIFARE_CMD_READ,255&e]);return 0!=_[0]?null:_.slice(1,_.length)}},{key:"mifareClassicWriteBlock",value:function(e,_){if(16!=_.length)throw"Data must be an array of 16 bytes!";return params=[1,MIFARE_CMD_WRITE,255&e].concat(_),0==this.callFunction(PN532_COMMAND_INDATAEXCHANGE,17,params)[0]}}]),e}();exports.default=PN532;
